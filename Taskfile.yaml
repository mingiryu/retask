# https://taskfile.dev

version: '3'

dotenv: [".env"]

env:
  SSH_KEY_PATH: "../.ssh/id_rsa"
  DEFAULT_TASK_FILE: "taskfiles/Python.yaml"

tasks:

  env: cp .env.dist .env

  ssh:
    cmds:
      - ssh-add $SSH_KEY_PATH
      - ssh root@$SSH_IP_ADDRESS -p $SSH_PORT

  clone:
    cmds:
      - scp -P $SSH_PORT -r $SSH_KEY_PATH root@$SSH_IP_ADDRESS:/root/.ssh/id_rsa
      - scp -P $SSH_PORT -r ~/.gitconfig root@$SSH_IP_ADDRESS:/root/.gitconfig
      - ssh root@$SSH_IP_ADDRESS -p $SSH_PORT "ssh-keyscan github.com >> ~/.ssh/known_hosts"
      - ssh root@$SSH_IP_ADDRESS -p $SSH_PORT "git clone $GIT_URI"

  taskfile:
    cmds:
      - ssh root@$SSH_IP_ADDRESS -p $SSH_PORT 'sh -c "$(curl --location https://taskfile.dev/install.sh)" -- -d -b /bin'
      - scp -P $SSH_PORT -r $DEFAULT_TASK_FILE root@$SSH_IP_ADDRESS:/root/Taskfile.yaml

  apt:
    cmds:
      - ssh root@$SSH_IP_ADDRESS -p $SSH_PORT 'apt update'
      - ssh root@$SSH_IP_ADDRESS -p $SSH_PORT 'apt install tmux nvtop -y'
  
  aws:
    cmds:
      - ssh root@$SSH_IP_ADDRESS -p $SSH_PORT 'apt update'
      - ssh root@$SSH_IP_ADDRESS -p $SSH_PORT 'apt install awscli -y'
      - task: aws:config
  
  aws:config:
    cmds:
      - scp -P $SSH_PORT -r ~/.aws root@$SSH_IP_ADDRESS:/root/.aws

  tunnel:
    cmds:
      - ssh -NL 8888:localhost:8888 root@$SSH_IP_ADDRESS -p $SSH_PORT
